(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3185],{5964:function(e,t,i){Promise.resolve().then(i.t.bind(i,3784,23)),Promise.resolve().then(i.bind(i,5925)),Promise.resolve().then(i.bind(i,4324)),Promise.resolve().then(i.bind(i,4523)),Promise.resolve().then(i.t.bind(i,2148,23))},4324:function(e,t,i){"use strict";i.r(t),i.d(t,{NotificationProvider:function(){return NotificationProvider},default:function(){return g},useNotifications:function(){return useNotifications}});var n=i(7437),o=i(2265),s=i(5243),r=i(2695),a=i(994),c=i(6690);let l={apiKey:"AIzaSyC1ViY0Z7duX8pjn9gOA4TkXoi7W9BYSro",authDomain:"bigdealegypt-1241b.firebaseapp.com",projectId:"bigdealegypt-1241b",storageBucket:"bigdealegypt-1241b.firebasestorage.app",messagingSenderId:"148632026753",appId:"1:148632026753:web:90e578add3ea695b919780"},u=null,d=null,initFirebase=async()=>{try{{let e=await (0,c.Gb)();if(!e)return console.log("Firebase Messaging is not supported in this browser"),!1;return d=(0,a.ZF)(l),u=(0,c.KL)(d),!0}}catch(e){return console.error("Error initializing Firebase:",e),!1}},requestNotificationPermission=async()=>{try{if(!u){let e=await initFirebase();if(!e)return null}if("granted"!==Notification.permission){let e=await Notification.requestPermission();if("granted"!==e)return console.log("Notification permission denied"),null}let e=await (0,c.LP)(u,{vapidKey:"BJbRlVX8z4Z9uL4vcE1p2Bw78zo_0DqpTUhgRRljS_2vvJuhwR5NZ2htVNmeAYuK6rUqVnjK2VcJKaDMqFgG6VY"});if(e)return console.log("FCM token obtained"),e;return console.log("No registration token available"),null}catch(e){return console.error("Error requesting notification permission:",e),null}},onForegroundMessage=e=>u?(0,c.ps)(u,t=>{e(t)}):(console.error("Firebase messaging not initialized"),()=>{}),saveFCMToken=async(e,t)=>{try{if(!e||!t)return!1;let n=await fetch("".concat("bigdealegypt.up.railway.app/api","/notifications/token"),{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({token:e,device_type:"web"}),credentials:"include"});if(!n.ok){var i;let e=await n.json();throw Error((null===(i=e.error)||void 0===i?void 0:i.message)||"Failed to save FCM token")}let o=await n.json();return o.success}catch(e){return console.error("Error saving FCM token:",e),!1}},f=(0,o.createContext)(null),useNotifications=()=>{let e=(0,o.useContext)(f);if(!e)throw Error("useNotifications must be used within a NotificationProvider");return e},NotificationProvider=e=>{let{children:t}=e,{user:i,session:a}=(0,s.a)(),{notifications:c}=(0,r.r)(),[l,u]=(0,o.useState)(null),[d,g]=(0,o.useState)(!1),[p,h]=(0,o.useState)(!1);(0,o.useEffect)(()=>{let setup=async()=>{if(!i||!(null==a?void 0:a.access_token)||!c)return;let e=!1!==c.push_notifications;if(e){let e=await initFirebase();if(g(e),e){let e=await requestNotificationPermission();if(e){let t=await saveFCMToken(e,a.access_token);h(t)}}}};setup()},[i,null==a?void 0:a.access_token,c]),(0,o.useEffect)(()=>{if(!d)return;console.log("Setting up foreground message handler");let e=onForegroundMessage(e=>{var t,i,n,o,s;if(console.log("Foreground message received:",e),"visible"!==document.visibilityState&&"granted"===Notification.permission){let t=new Notification(e.notification.title,{body:e.notification.body,icon:"/logo.png"});t.onclick=e=>{e.preventDefault(),window.focus(),t.close()}}u({id:(null===(t=e.data)||void 0===t?void 0:t.id)||Date.now().toString(),title:e.notification.title,message:e.notification.body,type:(null===(i=e.data)||void 0===i?void 0:i.type)||"system",related_entity_id:null===(n=e.data)||void 0===n?void 0:n.entityId,related_entity_type:null===(o=e.data)||void 0===o?void 0:o.entityType,link:null===(s=e.data)||void 0===s?void 0:s.link,is_read:!1,created_at:new Date().toISOString()});let r=document.getElementById("notification-sound");r&&r.play().catch(e=>console.log("Error playing notification sound:",e))});return()=>{"function"==typeof e&&e()}},[d]);let togglePushNotifications=async e=>{if(!e)return h(!1),!0;{if(!d){let e=await initFirebase();if(g(e),!e)return!1}let e=await requestNotificationPermission();if(e&&(null==a?void 0:a.access_token)){let t=await saveFCMToken(e,a.access_token);return h(t),t}return!1}};return(0,n.jsxs)(f.Provider,{value:{pushEnabled:p,newNotification:l,togglePushNotifications},children:[(0,n.jsx)("audio",{id:"notification-sound",preload:"auto",children:(0,n.jsx)("source",{src:"/sounds/notification.mp3",type:"audio/mpeg"})}),t]})};var g=NotificationProvider},2695:function(e,t,i){"use strict";i.d(t,{r:function(){return useSettings}});var n=i(2265),o=i(5243),s=i(3287);function useSettings(){let[e,t]=(0,n.useState)(!0),[i,r]=(0,n.useState)(null),{user:a,session:c}=(0,o.a)(),[l,u]=(0,n.useState)({name:"",email:"",phone:""}),[d,f]=(0,n.useState)({email_notifications:!0,sms_notifications:!0,push_notifications:!0,request_updates:!0,viewing_reminders:!0,marketing_emails:!1}),[g,p]=(0,n.useState)(null),fetchSettings=async()=>{if(!a||!(null==c?void 0:c.access_token)){t(!1);return}t(!0),r(null);try{var e,i,n,o,l,d;let t=await s.ZP.getUserSettings(c.access_token);u({name:t.profile.name||"",email:t.profile.email||"",phone:t.profile.phone||""}),f({email_notifications:null===(e=t.settings.email_notifications)||void 0===e||e,sms_notifications:null===(i=t.settings.sms_notifications)||void 0===i||i,push_notifications:null===(n=t.settings.push_notifications)||void 0===n||n,request_updates:null===(o=t.settings.request_updates)||void 0===o||o,viewing_reminders:null===(l=t.settings.viewing_reminders)||void 0===l||l,marketing_emails:null!==(d=t.settings.marketing_emails)&&void 0!==d&&d})}catch(e){console.error("Error fetching settings:",e),r(e.message||"Failed to fetch settings")}finally{t(!1)}},fetchSessions=async()=>{if(a&&(null==c?void 0:c.access_token))try{let e=await s.ZP.getUserSessions(c.access_token);p(e)}catch(e){console.error("Error fetching sessions:",e)}},updateProfile=async()=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{let e=await s.ZP.updateUserProfile(c.access_token,l);return u(t=>({...t,...e})),{success:!0}}catch(e){throw console.error("Error updating profile:",e),e}},updateNotifications=async()=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{let e=await s.ZP.updateNotificationSettings(c.access_token,d);return f(t=>({...t,...e})),{success:!0}}catch(e){throw console.error("Error updating notifications:",e),e}},updatePassword=async e=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{let t=await s.ZP.updatePassword(c.access_token,e);return t}catch(e){throw console.error("Error updating password:",e),e}},exportData=async()=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{let e=await s.ZP.exportUserData(c.access_token);return e}catch(e){throw console.error("Error exporting user data:",e),e}},deleteAccount=async e=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{let t=await s.ZP.deleteUserAccount(c.access_token,e);return t}catch(e){throw console.error("Error deleting account:",e),e}},terminateSession=async e=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{return await s.ZP.terminateSession(c.access_token,e),p(t=>({...t,otherSessions:t.otherSessions.filter(t=>t.id!==e)})),{success:!0}}catch(e){throw console.error("Error terminating session:",e),e}},terminateAllSessions=async()=>{if(!a||!(null==c?void 0:c.access_token))throw Error("User not authenticated");try{return await s.ZP.terminateAllSessions(c.access_token),p(e=>({...e,otherSessions:[]})),{success:!0}}catch(e){throw console.error("Error terminating all sessions:",e),e}};return(0,n.useEffect)(()=>{fetchSettings(),fetchSessions()},[a,null==c?void 0:c.access_token]),{loading:e,error:i,profile:l,setProfile:u,notifications:d,setNotifications:f,sessionData:g,updateProfile,updateNotifications,updatePassword,exportData,deleteAccount,terminateSession,terminateAllSessions,refreshSettings:fetchSettings,refreshSessions:fetchSessions}}},2148:function(){}},function(e){e.O(0,[2849,35,2971,2472,1744],function(){return e(e.s=5964)}),_N_E=e.O()}]);